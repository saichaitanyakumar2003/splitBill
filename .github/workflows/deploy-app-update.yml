name: Deploy App Update (OTA)

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'app/**'
      - '.github/workflows/deploy-app-update.yml'
  workflow_dispatch: # Allows manual triggering

jobs:
  update:
    name: Publish OTA Update
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Starting OTA Update
        run: |
          echo "=========================================="
          echo "ğŸ“± Publishing OTA Update to Expo"
          echo "=========================================="
          echo "ğŸ“… Triggered at: $(date)"
          echo "ğŸ”€ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ”§ Setup Expo CLI
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: âœ… Verify Expo Authentication
        run: |
          echo "ğŸ” Checking Expo authentication..."
          eas whoami
          echo "âœ… Authenticated successfully!"

      - name: ğŸ“š Install dependencies
        working-directory: ./app
        run: |
          echo "ğŸ“š Installing npm dependencies..."
          npm install
          echo "âœ… Dependencies installed!"

      - name: ğŸ“¤ Publish OTA Update to Preview Channel
        working-directory: ./app
        run: |
          echo "ğŸ“¤ Publishing OTA update to preview channel..."
          eas update --channel preview --non-interactive --message "Auto update from commit ${{ github.sha }}"
          echo "âœ… OTA Update published to preview channel!"

      - name: ğŸ“¤ Publish OTA Update to Production Channel
        working-directory: ./app
        run: |
          echo "ğŸ“¤ Publishing OTA update to production channel..."
          eas update --channel production --non-interactive --message "Auto update from commit ${{ github.sha }}"
          echo "âœ… OTA Update published to production channel!"

      - name: ğŸ“‹ Update Summary
        run: |
          echo "=========================================="
          echo "âœ… OTA UPDATE SUCCESSFUL!"
          echo "=========================================="
          echo "ğŸ“± Updates published to: preview & production channels"
          echo "ğŸ“± Users will receive the update on next app restart"
          echo "ğŸ“… Completed at: $(date)"
          echo "=========================================="
