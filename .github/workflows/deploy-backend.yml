name: Deploy Backend to Render

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Starting Backend Deployment
        run: |
          echo "=========================================="
          echo "ğŸ–¥ï¸ Deploying SplitBill Backend to Render"
          echo "=========================================="
          echo "ğŸ“… Triggered at: $(date)"
          echo "ğŸ”€ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“š Install dependencies
        working-directory: ./backend
        run: |
          echo "ğŸ“š Installing npm dependencies..."
          npm install
          echo "âœ… Dependencies installed!"

      - name: ğŸ§ª Run tests
        working-directory: ./backend
        run: |
          echo "ğŸ§ª Running tests..."
          npm test --if-present
          echo "âœ… Tests passed!"

      - name: ğŸš€ Deploy to Render
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          echo "ğŸš€ Triggering Render deployment..."
          
          if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "âš ï¸ RENDER_DEPLOY_HOOK_URL secret not set. Skipping deployment."
            exit 0
          fi
          
          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$RENDER_DEPLOY_HOOK_URL")
          
          # Check for any 2xx success status code
          if [[ "$response" =~ ^2[0-9][0-9]$ ]]; then
            echo "âœ… Render deployment triggered successfully! (HTTP $response)"
            echo "â³ Render is now building and deploying your backend..."
            echo "ğŸ”— Check status at: https://dashboard.render.com"
          else
            echo "âŒ Failed to trigger deployment. HTTP status: $response"
            exit 1
          fi

      - name: ğŸ“‹ Deployment Summary
        run: |
          echo "=========================================="
          echo "âœ… BACKEND DEPLOYMENT TRIGGERED!"
          echo "=========================================="
          echo "ğŸ–¥ï¸ Backend URL: https://splitbill-i6ou.onrender.com"
          echo "â¤ï¸ Health Check: https://splitbill-i6ou.onrender.com/health"
          echo "ğŸ“… Completed at: $(date)"
          echo "â³ Note: Render may take 2-5 mins to complete deployment"
          echo "=========================================="
